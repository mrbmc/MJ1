/**UV: 3.5v (max 4.1) / < 350mAWHITE: 3.3v (max 3.8) / < 30mA*/import flash.display.StageDisplayState;import fl.controls.Button;import fl.controls.Slider;import fl.controls.SliderDirection;import fl.controls.NumericStepper;import fl.controls.CheckBox;import fl.events.SliderEvent;import flash.events.MouseEvent;import com.wcp.*;include 'phidget.as';var globalBrightness = 100;var globalSpeed = 120;var myFormat:TextFormat = new TextFormat();	myFormat.font = "_sans";	myFormat.size = 10;	myFormat.color = 0xFFFFFF; //redfunction _trace (o:Object) {	msg = (o is DebugEvent) ? o.msg : o;	trace(msg);	myConsole.text = msg+"\n"+myConsole.text;}String.prototype.titleCase = function (_input:String=null) {	inputString = (_input==null)?this:_input;	return inputString.split(" ").map(function(element:String, index:int, arr:Array):String{		return element.substr(0, 1).toLocaleUpperCase() + element.substr(1);	}).join(" ");}function goFullScreen(event:Event):void{	if (stage.displayState == StageDisplayState.FULL_SCREEN) {		stage.removeEventListener(Event.ENTER_FRAME,_handleEnterFrame);		trace(stage.displayState);	} else {		stage.displayState=StageDisplayState.FULL_SCREEN;	}}stage.addEventListener(Event.ENTER_FRAME, goFullScreen)//------------------------------------------------------//INIT ANIMATION ENGINEvar engine = new Engine();var sequencer = new Sequencer();addEventListener("light",light);engine.addEventListener("light",light);engine.addEventListener("debug",_trace);engine.addEventListener("effect",sequencer.listener);sequencer.addEventListener("effect",engine.listener);//------------------------------------------------------//PREVIEWvar gridWrapper = new MovieClip();	gridWrapper.x = 10;	gridWrapper.y = 200;addChild(gridWrapper);var gridRef = new Array();var tube:Tube;// = new MovieClip();var w = 40;var h = 10;var row = 0;var rows = 8;var steps = 12;for (i=0;i<(rows*2);i++) {	tube = new Tube(i,80,Math.round(Math.random()*360),0x00FFFF)	//tube.id = "tube" + i;	tube.x = (i%rows)*(w+5);	tube.y = (Math.floor(i/rows)*(250));	gridWrapper.addChild(tube);}var cbSyncBanks:CheckBox = new CheckBox();	cbSyncBanks.move(((w+5)*rows),0);	cbSyncBanks.label = "synch banks";	cbSyncBanks.addEventListener(MouseEvent.CLICK, synchHandler);	cbSyncBanks.setStyle("textFormat", myFormat);gridWrapper.addChild(cbSyncBanks);function synchHandler(e:MouseEvent) {}var picker:Picker = new Picker('picknose',300,100);gridWrapper.addChild(picker);picker.x = (w+5) * rows;picker.y = 20;picker.addEventListener("color",onColor);import flash.geom.ColorTransform;function onColor (e:ColorEvent) {	trace (e.color);	var newColorTransform:ColorTransform = gridWrapper.transform.colorTransform;		newColorTransform.color = 0xff00ff;		gridWrapper.colorTransform = newColorTransform;		for(i=0;i<8;i++) {		var target_mc = gridWrapper.getChildByName('tube' + i);for (var i:uint = 0; i < target_mc.numChildren; i++){	trace ('\t|\t ' +i+'.\t name:' + target_mc.getChildAt(i).name + '\t type:' + typeof (target_mc.getChildAt(i))+ '\t' + target_mc.getChildAt(i));}	}}//gridWrapper.visible = false;//------------------------------------------------------// /GRID CONTROLLER//------------------------------------------------------// PARAMETER CONTROLSfunction brightnessHandler(event:Event):void {	globalBrightness = event.value;	controlWrapper.volumeLabel.text = globalBrightness;//	for(var i=0;i<64;i++) light( i, event.value);//	_trace("Light: "+LEDIndex.value + " = " + event.value);}/*var brightnessSlider:Slider = new Slider();	brightnessSlider.move(0,80);	brightnessSlider.setSize(200,20);	brightnessSlider.liveDragging = true;	brightnessSlider.minimum = 0;	brightnessSlider.maximum = 100;	brightnessSlider.snapInterval = 1;	brightnessSlider.tickInterval = 5;	brightnessSlider.value = globalBrightness;	//brightnessSlider.direction = SliderDirection.VERTICAL;controlWrapper.addChild(brightnessSlider);*/controlWrapper.brightnessSlider.addEventListener(SliderEvent.CHANGE, brightnessHandler);controlWrapper.volumeLabel.text = globalBrightness;function speedHandler(e:SliderEvent):int {	engine.speed = e.value;	controlWrapper.speedLabel.text = e.value;}function speedInputHandler(e:Event):int {	//trace(e);	engine.speed = e.value;	speedSlider.value = e.value;}/*var speedSlider:Slider = new Slider();	speedSlider.move(brightnessSlider.x,brightnessSlider.y+60);	speedSlider.setSize(200,3);	speedSlider.liveDragging = true;	speedSlider.value = engine.speed;	speedSlider.minimum = 1;	speedSlider.maximum = 600;	speedSlider.snapInterval = 1;	speedSlider.tickInterval = 40;	speedSlider.value = globalSpeed;	//speedSlider.direction = SliderDirection.VERTICAL;addChild(speedSlider);*/controlWrapper.speedSlider.addEventListener(SliderEvent.CHANGE, speedHandler);controlWrapper.speedLabel.text = globalSpeed;controlWrapper.loopControl.addEventListener(MouseEvent.CLICK, parameterHandler);controlWrapper.loopControl.setStyle("textFormat", myFormat);//controlWrapper.randomControl.addEventListener(MouseEvent.CLICK, parameterHandler);controlWrapper.reflectControl.addEventListener(MouseEvent.CLICK, parameterHandler);controlWrapper.reflectControl.setStyle("textFormat", myFormat);controlWrapper.reverseControl.addEventListener(MouseEvent.CLICK, parameterHandler);controlWrapper.reverseControl.setStyle("textFormat", myFormat);controlWrapper.trailControl.addEventListener(Event.CHANGE,parameterHandler);function parameterHandler(e:Event):void {	engine.loop = controlWrapper.loopControl.selected;//	engine.randomize = controlWrapper.randomControl.selected;	engine.reflect = controlWrapper.reflectControl.selected;	engine.reverse = controlWrapper.reverseControl.selected;	engine.trail = controlWrapper.trailControl.value;}function playerHandler(e:Event) {	switch(e.target.name) {		case "playButton":			if(!sequencer.hasItems())				return;			sequencer.go(true);			controlWrapper.playButton.visible = false;		break;		case "stopButton":			sequencer.go(false);			controlWrapper.playButton.visible = true;		break;		case "backButton":			sequencer.go();		break;		case "nextButton":			sequencer.stepper();		break;	}}controlWrapper.playButton.addEventListener(MouseEvent.CLICK,playerHandler);controlWrapper.stopButton.addEventListener(MouseEvent.CLICK,playerHandler);controlWrapper.backButton.addEventListener(MouseEvent.CLICK,playerHandler);controlWrapper.nextButton.addEventListener(MouseEvent.CLICK,playerHandler);//------------------------------------------------------//SEQUENCER/*var console:MovieClip = new MovieClip();	console.x = 5;	console.y = 315;addChild(console);*/var effects:EffectFactory = new EffectFactory();var hotkeys:Array = new Array("q","w","e","r","t","y","u","i","o","p");var hotKeysMap:Array = new Array();var j = 0;for(var effectName in effects.library) {	if(!effects.library[effectName].hasChannel)		continue;	var channel:Channel = new Channel(effectName,hotkeys[j]);		channel.x = 0;		channel.y = (j*45)+30;		channel.addEventListener("effect",engine.listener);		channel.addEventListener("effect",sequencer.listener);	sequencerWrapper.addChild(channel);	hotKeysMap[hotkeys[j]] = channel;	sequencer.addEventListener("effect",channel.queueHandler);	j++;}//------------------------------------------------------//MAGIC BUTTONSvar starIndex = 0;var starArray = new Array(6,10,7,0,8,5,9,2,4,3,11,1);function wishHandler(e:MouseEvent):void {	var fx = effects.make("stars");		fx.sequence = new Array();	//for(i=0;i<16;i++) fx.sequence.push(new Array());	//var star = Math.floor(Math.random()*12)*5;	var star = starArray[starIndex]*5;	trace(star);	for(i=(star+4),end=star;i>=end;i--) {		fx.sequence.push(new Array(i+""));	}	star = (star>=30) ? star-30 : star+30;	//if star-=60;	for(i=star,end=star+5;i<end;i++) {		fx.sequence.push(new Array(i+""));	}	//for(i=0;i<16;i++) fx.sequence.push(new Array());	engine.go(fx);	starIndex++;	if(starIndex>=12) starIndex = 0;}var wishButton:Button = new Button();	wishButton.setSize(100,40);	wishButton.move(1024-112,30);	wishButton.label = "Make a wish";	wishButton.addEventListener(MouseEvent.MOUSE_DOWN,wishHandler);sequencerWrapper.addChild(wishButton);function strobeHandler(e:MouseEvent):void {	engine.go(effects.make("strobe"));}var strobeButton:Button = new Button();	strobeButton.setSize(100,40);	strobeButton.move(wishButton.x,wishButton.y+50);	strobeButton.label = "Camera's Ready";	strobeButton.addEventListener(MouseEvent.MOUSE_DOWN,strobeHandler);sequencerWrapper.addChild(strobeButton);function ballHandler(e:MouseEvent):void {	engine.go(effects.make("discoball"));}var ballButton:Button = new Button();	ballButton.setSize(100,40);	ballButton.move(wishButton.x,strobeButton.y+50);	ballButton.label = "discoball";	ballButton.addEventListener(MouseEvent.MOUSE_DOWN,ballHandler);sequencerWrapper.addChild(ballButton);function uvHandler(e:SliderEvent):int {	//var uv:Array = new Array(new Array());	for(i=60;i<64;i++) {		dispatchEvent(new LightEvent(i,e.value,null));		gridRef[i].lite.alpha = 0;		gridRef[i].alpha = e.value/100;	}}var uvSlider:Slider = new Slider();	uvSlider.move(wishButton.x+50,ballButton.y+50);	uvSlider.setSize(100,10);	uvSlider.liveDragging = true;	uvSlider.value = engine.speed;	uvSlider.minimum = 0;	uvSlider.maximum = 100;	uvSlider.snapInterval = 1;	uvSlider.tickInterval = 10;	uvSlider.value = 0;	uvSlider.direction = SliderDirection.VERTICAL;	uvSlider.addEventListener(SliderEvent.CHANGE, uvHandler);sequencerWrapper.addChild(uvSlider);function blackHandler(e:Event):void {	engine.blackout();	blackout();}var BlackButton:Button = new Button();	BlackButton.setSize(100,40);	BlackButton.move(wishButton.x,390);	BlackButton.label = "blackout";	BlackButton.addEventListener(MouseEvent.MOUSE_DOWN,blackHandler);sequencerWrapper.addChild(BlackButton);sequencer.addEventListener("blackout",blackHandler);sequencerWrapper.visible = false;// /EFFECTS SEQUENCER //------------------------------------------------------//------------------------------------------------------// KEYBOARD HANDLERfunction reportKeyDown(event:KeyboardEvent):void { 	var key = String.fromCharCode(event.charCode);	switch(key) {	case " ":		sequencer.go();	break;	case "z":		engine.go(engine.fx);	break;	case "x":		sequencer.stepper();	break;	case "l":		engine.loop = loopControl.selected = !engine.loop;	break;	case "q":	case "w":	case "e":	case "r":	case "t":	case "y":	case "u":	case "i":	case "o":	case "p":		hotKeysMap[key].go();	break;	case "b":		engine.go(effects.make("discoball"));	break;	case "m":		engine.go(effects.make("strobe"));	break;		case "1":	case "2":	case "3":	case "4":	case "5":	case "6":	case "7":	case "8":	case "9":		globalBrightness = key*10;		controlWrapper.brightnessSlider.value = globalBrightness;//		for(i=0;i<64;i++) light( i, globalBrightness);	break;	case "`":		globalBrightness = 0;		controlWrapper.brightnessSlider.value = globalBrightness;	break;	case "0":		globalBrightness = 100;		controlWrapper.brightnessSlider.value = globalBrightness;	break;	default:		_trace("Key Pressed: " + String.fromCharCode(event.charCode) +         " (character code: " + event.charCode + ")"); 	break;	}} stage.addEventListener(KeyboardEvent.KEY_DOWN, reportKeyDown);