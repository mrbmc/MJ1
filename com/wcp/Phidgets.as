package com.wcp {	import com.phidgets.Phidget;	import com.phidgets.PhidgetLED;	import com.phidgets.PhidgetServo;	import com.phidgets.events.*;	import com.wcp.DebugEvent;	import flash.events.Event;	import flash.display.Sprite;	public class Phidgets extends Sprite {		private var ceiling:PhidgetLED = new PhidgetLED();		private var wallLed:PhidgetLED = new PhidgetLED();		private var wallServoL:PhidgetServo = new PhidgetServo();		private var wallServoR:PhidgetServo = new PhidgetServo();		protected var nServoResetPosition:Number = 90;		// Last animation frame of commands sent prevents repeat commands.		private var aLightArchive = new Array(60);		public var globalBrightness:Number = 100;		public function Phidgets ():void {			initPhidget(ceiling);			initPhidget(wallLed);			initPhidget(wallServoL);			initPhidget(wallServoR);			for(i=0;i<60;i++){				aLightArchive[i] = (0);			}		}		private function _trace (o:Object):void {			dispatchEvent(new DebugEvent(o));		}				private function initPhidget(p:Phidget):void {			p.addEventListener(PhidgetEvent.CONNECT, this.onConnect);			p.addEventListener(PhidgetEvent.DETACH,	this.onDetach);			p.addEventListener(PhidgetEvent.ATTACH,	this.onAttach);			p.addEventListener(PhidgetErrorEvent.ERROR, this.onError);			p.open("localhost", 5001);		}		private function onConnect(e:PhidgetEvent):void {			_trace(e);		}		private function onAttach(e:PhidgetEvent):void {			//_trace(e);			_trace(e.Device.Name + 				   ":" + e.Device.Type + 				   " serial# " + e.Device.serialNumber + 				   " v" + e.Device.Version				   );			if(e.Device.Type == "PhidgetLED") {				/*				UV: 3.5v (max 4.1) / < 350mA				WHITE: 3.3v (max 3.8) / < 30mA				*/				p.CurrentLimit = 1;				p.Voltage = 2.0;				_trace("current:"+p.CurrentLimit + " / voltage:"+p.Voltage);			} else if (e.Device.Type == "PhidgetServo") {				p.setPosition(0,nServoResetPosition);				_trace("position:" + p.getPosition);			}		}		private function onDetach(e:PhidgetEvent):void {			_trace(e);		}				private function onError(e:PhidgetErrorEvent):void {		//	if(e.indexOf("400")<=0)		//		trace(e);		}				public function sn1 (e:LightEvent):void {			var _brightness:int = 0;			if(e.display!=null){				for(i in e.display) {					_brightness = (i<60) ? (e.display[i]/100*globalBrightness) : e.display[i];					if(aLightArchive[i] != _brightness || _brightness<=0)						ceiling.setDiscreteLED( i, _brightness );					aLightArchive[i]=_brightness;				}			} else {				_brightness = (e.index<60) ? (e.brightness/100*globalBrightness) : e.brightness;				ceiling.setDiscreteLED( e.index, _brightness );				aLightArchive[e.index] = _brightness;			}			return;		}				public function MJ1 (e:TubeEvent):void {			if(e.display!=null){				for(i in e.display) {					_brightness = (i<60) ? (e.display[i]/100 * globalBrightness) : e.display[i];					//optimize events sent to phidgets by not sending dupes					if(aLightArchive[i] != _brightness || _brightness<=0)						wallLed.setDiscreteLED( i, _brightness );					aLightArchive[i]=_brightness;				}			} else {				_brightness = (e.index<60) ? (e.brightness / 100 * globalBrightness) : e.brightness;				wallLed.setDiscreteLED( e.index, _brightness );				aLightArchive[e.index] = _brightness;			}		}				public function blackout() {			for(i=0;i<64;i++) {				ceiling.setDiscreteLED( i, 0 );			}			for(i=0;i<48;i++) {				wallLed.setDiscreteLED( i, 0 );			}			for(i=0;i<16;i++) {				if(i<8) {					//wallServoL.setPosition( i, nServoResetPosition );				} else {					//wallServoR.setPosition( i, nServoResetPosition );				}			}		}				public function listener (e:Event) {			if(e is TubeEvent) {				this.MJ1(e);			} else if (e is LightEvent) {				this.sn1(e);			}		}	}}